<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UZUM Dashboard Debug</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #7c3aed;
      margin-top: 0;
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #7c3aed;
      padding-bottom: 10px;
    }
    button {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #6d28d9;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .output {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      color: #22c55e;
      font-weight: 600;
    }
    .error {
      color: #ef4444;
      font-weight: 600;
    }
    .info {
      color: #3b82f6;
      font-weight: 600;
    }
    .warn {
      color: #f59e0b;
      font-weight: 600;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
    }
    .stat-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <h1>üîç UZUM Dashboard Debug</h1>
  
  <div class="section">
    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
    <input type="text" id="token" placeholder="–í–≤–µ–¥–∏—Ç–µ UZUM —Ç–æ–∫–µ–Ω" />
    <input type="text" id="shopId" placeholder="–í–≤–µ–¥–∏—Ç–µ Shop ID" />
    <button onclick="saveCredentials()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
    <div id="creds-status" class="output" style="display: none;"></div>
  </div>

  <div class="section">
    <h2>–¢–µ—Å—Ç—ã API</h2>
    <button onclick="testStocks()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ (Stocks)</button>
    <button onclick="testFinanceOrders()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–∫–∞–∑—ã (Finance Orders)</button>
    <button onclick="testFinanceExpenses()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã (Finance Expenses)</button>
    <button onclick="testAll()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
    <button onclick="clearOutput()">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–≤–æ–¥</button>
  </div>

  <div class="section">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
    <div id="output" class="output">
      –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤...
      
      –í–ê–ñ–ù–û: –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤!
    </div>
  </div>

  <div class="section" id="stats-section" style="display: none;">
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div id="stats" class="stats"></div>
  </div>

  <script>
    const PROXY_URL = 'https://ykbouygdeqrohizeqlmc.supabase.co/functions/v1/uzum-proxy';
    let TOKEN = '';
    let SHOP_ID = '';

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ credentials –∏–∑ localStorage
    window.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('uzum_debug_creds');
      if (saved) {
        try {
          const creds = JSON.parse(saved);
          TOKEN = creds.token || '';
          SHOP_ID = creds.shopId || '';
          document.getElementById('token').value = TOKEN;
          document.getElementById('shopId').value = SHOP_ID;
          log('‚úì –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'success');
        } catch (e) {
          console.error('Failed to load saved credentials', e);
        }
      }
    });

    function saveCredentials() {
      TOKEN = document.getElementById('token').value.trim();
      SHOP_ID = document.getElementById('shopId').value.trim();
      
      if (!TOKEN || !SHOP_ID) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è!');
        return;
      }

      localStorage.setItem('uzum_debug_creds', JSON.stringify({ token: TOKEN, shopId: SHOP_ID }));
      
      const status = document.getElementById('creds-status');
      status.style.display = 'block';
      status.innerHTML = '<span class="success">‚úì –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</span>';
      
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    }

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
      
      // Also log to console
      console.log(`[${timestamp}] ${message}`);
    }

    function clearOutput() {
      document.getElementById('output').innerHTML = '–í—ã–≤–æ–¥ –æ—á–∏—â–µ–Ω. –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤—ã–º —Ç–µ—Å—Ç–∞–º...\n\n';
      document.getElementById('stats-section').style.display = 'none';
    }

    async function makeRequest(endpoint, method = 'GET', body = null) {
      if (!TOKEN || !SHOP_ID) {
        alert('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!');
        throw new Error('Missing credentials');
      }

      const proxyBody = {
        path: endpoint,
        method: method,
        headers: {
          'Authorization': TOKEN,
        },
      };

      if (body && method !== 'GET') {
        proxyBody.body = body;
      }

      console.log('üì° Making request:', { endpoint, method, proxyBody });
      log(`üì° –ó–∞–ø—Ä–æ—Å: ${method} ${endpoint}`);

      try {
        const response = await fetch(PROXY_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(proxyBody),
        });

        const status = response.status;
        console.log('Response status:', status);
        log(`   –°—Ç–∞—Ç—É—Å: ${status}`, status === 200 ? 'success' : 'error');

        if (!response.ok) {
          const text = await response.text();
          console.error('Response error:', text);
          log(`   ‚ùå –û—à–∏–±–∫–∞: ${text}`, 'error');
          return { success: false, status, error: text };
        }

        const data = await response.json();
        console.log('Response data:', data);
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º payload –µ—Å–ª–∏ –µ—Å—Ç—å
        let result = data;
        if (data && typeof data === 'object' && 'payload' in data) {
          console.log('Extracting payload from response');
          log('   üì¶ –ò–∑–≤–ª–µ—á–µ–Ω payload –∏–∑ –æ—Ç–≤–µ—Ç–∞');
          result = data.payload;
        }

        log(`   ‚úì –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã`, 'success');
        return { success: true, status, data: result };

      } catch (error) {
        console.error('Network error:', error);
        log(`   ‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
        return { success: false, error: error.message };
      }
    }

    async function testStocks() {
      log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
      log('–¢–ï–°–¢: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ (Stocks)', 'info');
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', 'info');

      const result = await makeRequest('/v2/fbs/sku/stocks?limit=100&offset=0');
      
      if (!result.success) {
        log('\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏', 'error');
        return;
      }

      console.log('Stocks data:', result.data);
      log('\nüìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö:');
      log(`   –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: ${typeof result.data}`);
      log(`   –≠—Ç–æ –º–∞—Å—Å–∏–≤? ${Array.isArray(result.data)}`);
      
      if (result.data && typeof result.data === 'object') {
        log(`   –ö–ª—é—á–∏: ${Object.keys(result.data).join(', ')}`);
      }

      // –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –º–∞—Å—Å–∏–≤ –æ—Å—Ç–∞—Ç–∫–æ–≤
      let stocks = null;
      if (Array.isArray(result.data)) {
        stocks = result.data;
        log('   ‚úì –î–∞–Ω–Ω—ã–µ - —ç—Ç–æ –ø—Ä—è–º–æ–π –º–∞—Å—Å–∏–≤', 'success');
      } else if (result.data?.items && Array.isArray(result.data.items)) {
        stocks = result.data.items;
        log('   ‚úì –î–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–µ "items"', 'success');
      } else if (result.data?.stocks && Array.isArray(result.data.stocks)) {
        stocks = result.data.stocks;
        log('   ‚úì –î–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–µ "stocks"', 'success');
      } else if (result.data?.data && Array.isArray(result.data.data)) {
        stocks = result.data.data;
        log('   ‚úì –î–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–µ "data"', 'success');
      } else {
        log('   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–∞—Å—Å–∏–≤ –æ—Å—Ç–∞—Ç–∫–æ–≤', 'warn');
        log('\nüìÑ –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç API:', 'warn');
        log(JSON.stringify(result.data, null, 2), 'warn');
        return;
      }

      log(`\n   üì¶ –ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${stocks.length}`, 'success');

      if (stocks.length === 0) {
        log('   ‚ö†Ô∏è  –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏!', 'warn');
        return;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
      console.log('First stock item:', stocks[0]);
      log('\n   –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞:');
      log(JSON.stringify(stocks[0], null, 2));

      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ —Ç–∏–ø–∞–º —Å–∫–ª–∞–¥–∞
      let fboTotal = 0;
      let fbsTotal = 0;
      let dbsTotal = 0;

      stocks.forEach((item) => {
        const warehouseType = item.warehouseType || item.warehouse_type || '';
        const amount = item.amount || item.stock || item.quantity || 0;

        if (warehouseType.toLowerCase().includes('fbo')) {
          fboTotal += amount;
        } else if (warehouseType.toLowerCase().includes('fbs')) {
          fbsTotal += amount;
        } else if (warehouseType.toLowerCase().includes('dbs')) {
          dbsTotal += amount;
        }
      });

      const total = fboTotal + fbsTotal + dbsTotal;

      log('\nüìä –ò—Ç–æ–≥–æ–≤—ã–µ –æ—Å—Ç–∞—Ç–∫–∏:', 'success');
      log(`   FBO: ${fboTotal}`, 'success');
      log(`   FBS: ${fbsTotal}`, 'success');
      log(`   DBS: ${dbsTotal}`, 'success');
      log(`   –í—Å–µ–≥–æ: ${total}`, 'success');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      showStats({
        'FBO –æ—Å—Ç–∞—Ç–∫–∏': fboTotal,
        'FBS –æ—Å—Ç–∞—Ç–∫–∏': fbsTotal,
        'DBS –æ—Å—Ç–∞—Ç–∫–∏': dbsTotal,
        '–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤': stocks.length,
      });
    }

    async function testFinanceOrders() {
      log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
      log('–¢–ï–°–¢: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (Finance Orders)', 'info');
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', 'info');

      // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
      const endDate = Date.now();
      const startDate = endDate - (7 * 24 * 60 * 60 * 1000);

      const endpoint = `/v1/finance/orders?shopId=${SHOP_ID}&shopIds=${SHOP_ID}&size=100&page=0&dateFrom=${startDate}&dateTo=${endDate}`;
      const result = await makeRequest(endpoint);
      
      if (!result.success) {
        log('\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã', 'error');
        return;
      }

      console.log('Finance orders data:', result.data);
      log('\nüìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö:');
      log(`   –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: ${typeof result.data}`);
      
      if (result.data && typeof result.data === 'object') {
        log(`   –ö–ª—é—á–∏: ${Object.keys(result.data).join(', ')}`);
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–∫–∞–∑—ã
      const orders = result.data?.orderItems || [];
      const total = result.data?.totalElements || 0;

      log(`\n   üì¶ –ù–∞–π–¥–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${orders.length} –∏–∑ ${total}`, 'success');

      if (orders.length === 0) {
        log('   ‚ö†Ô∏è  –ù–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π!', 'warn');
        return;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
      console.log('First order:', orders[0]);
      log('\n   –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞:');
      log(JSON.stringify(orders[0], null, 2));

      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Ä—É—á–∫—É –∏ –ø—Ä–∏–±—ã–ª—å
      let revenue = 0;
      let profit = 0;

      orders.forEach(order => {
        const sellPrice = order.sellPrice || 0;
        const amount = order.amount || 1;
        const sellerProfit = order.sellerProfit || 0;

        revenue += sellPrice * amount;
        profit += sellerProfit * amount;
      });

      log('\nüí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π):', 'success');
      log(`   –í—ã—Ä—É—á–∫–∞: ${revenue.toLocaleString('ru-RU')} —Å—É–º`, 'success');
      log(`   –ü—Ä–∏–±—ã–ª—å: ${profit.toLocaleString('ru-RU')} —Å—É–º`, 'success');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      showStats({
        '–ó–∞–∫–∞–∑–æ–≤': orders.length,
        '–í—ã—Ä—É—á–∫–∞ (—Å—É–º)': revenue.toLocaleString('ru-RU'),
        '–ü—Ä–∏–±—ã–ª—å (—Å—É–º)': profit.toLocaleString('ru-RU'),
      });
    }

    async function testFinanceExpenses() {
      log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
      log('–¢–ï–°–¢: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ (Finance Expenses)', 'info');
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', 'info');

      // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
      const endDate = Date.now();
      const startDate = endDate - (7 * 24 * 60 * 60 * 1000);

      const endpoint = `/v1/finance/expenses?shopIds=${SHOP_ID}&size=100&page=0&dateFrom=${startDate}&dateTo=${endDate}`;
      const result = await makeRequest(endpoint);
      
      if (!result.success) {
        log('\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã', 'error');
        return;
      }

      console.log('Finance expenses data:', result.data);
      log('\nüìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö:');
      log(`   –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: ${typeof result.data}`);
      
      if (result.data && typeof result.data === 'object') {
        log(`   –ö–ª—é—á–∏: ${Object.keys(result.data).join(', ')}`);
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã - API –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
      let expenses = [];
      if (result.data?.payload?.payments) {
        expenses = result.data.payload.payments;
        log('   ‚úì –î–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–µ "payload.payments"', 'success');
      } else if (Array.isArray(result.data)) {
        expenses = result.data;
        log('   ‚úì –î–∞–Ω–Ω—ã–µ - —ç—Ç–æ –ø—Ä—è–º–æ–π –º–∞—Å—Å–∏–≤', 'success');
      } else if (result.data?.expenses) {
        expenses = result.data.expenses;
        log('   ‚úì –î–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–µ "expenses"', 'success');
      } else {
        log('   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–∞—Å—Å–∏–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤', 'warn');
        log('\nüìÑ –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç API:', 'warn');
        log(JSON.stringify(result.data, null, 2), 'warn');
        return;
      }

      log(`\n   üì¶ –ù–∞–π–¥–µ–Ω–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: ${expenses.length}`, 'success');

      if (expenses.length === 0) {
        log('   ‚ö†Ô∏è  –ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π!', 'warn');
        return;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞—Å—Ö–æ–¥ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
      console.log('First expense:', expenses[0]);
      log('\n   –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞:');
      log(JSON.stringify(expenses[0], null, 2));

      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
      const expensesByCategory = {
        marketing: 0,
        commission: 0,
        logistics: 0,
        fines: 0,
      };

      expenses.forEach(expense => {
        const amount = Math.abs(
          expense.paymentPrice || 
          expense.amount || 
          expense.price || 
          expense.sum || 
          0
        );
        
        const type = (expense.type || expense.category || '').toLowerCase();
        const source = (expense.source || '').toLowerCase();
        const description = (expense.description || expense.name || '').toLowerCase();
        
        const allText = `${type} ${source} ${description}`.toLowerCase();
        
        if (allText.includes('market') || allText.includes('–º–∞—Ä–∫–µ—Ç') || allText.includes('marketing') || allText.includes('—Ä–µ–∫–ª–∞–º')) {
          expensesByCategory.marketing += amount;
        } else if (allText.includes('commi') || allText.includes('–∫–æ–º–∏—Å—Å') || allText.includes('fee') || allText.includes('—Å–±–æ—Ä')) {
          expensesByCategory.commission += amount;
        } else if (allText.includes('logist') || allText.includes('–ª–æ–≥–∏—Å—Ç') || allText.includes('delivery') || allText.includes('–¥–æ—Å—Ç–∞–≤–∫') || allText.includes('shipping')) {
          expensesByCategory.logistics += amount;
        } else if (allText.includes('fine') || allText.includes('—à—Ç—Ä–∞—Ñ') || allText.includes('penalty') || allText.includes('–ø–µ–Ω—è')) {
          expensesByCategory.fines += amount;
        } else {
          expensesByCategory.commission += amount;
        }
      });

      const totalExpenses = Object.values(expensesByCategory).reduce((a, b) => a + b, 0);

      log('\nüí∏ –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π):', 'success');
      log(`   –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥: ${expensesByCategory.marketing.toLocaleString('ru-RU')} —Å—É–º`, 'success');
      log(`   –ö–æ–º–∏—Å—Å–∏—è: ${expensesByCategory.commission.toLocaleString('ru-RU')} —Å—É–º`, 'success');
      log(`   –õ–æ–≥–∏—Å—Ç–∏–∫–∞: ${expensesByCategory.logistics.toLocaleString('ru-RU')} —Å—É–º`, 'success');
      log(`   –®—Ç—Ä–∞—Ñ—ã: ${expensesByCategory.fines.toLocaleString('ru-RU')} —Å—É–º`, 'success');
      log(`   –ò–¢–û–ì–û: ${totalExpenses.toLocaleString('ru-RU')} —Å—É–º`, 'success');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      showStats({
        '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ (—Å—É–º)': expensesByCategory.marketing.toLocaleString('ru-RU'),
        '–ö–æ–º–∏—Å—Å–∏—è (—Å—É–º)': expensesByCategory.commission.toLocaleString('ru-RU'),
        '–õ–æ–≥–∏—Å—Ç–∏–∫–∞ (—Å—É–º)': expensesByCategory.logistics.toLocaleString('ru-RU'),
        '–®—Ç—Ä–∞—Ñ—ã (—Å—É–º)': expensesByCategory.fines.toLocaleString('ru-RU'),
      });
    }

    async function testAll() {
      clearOutput();
      log('üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤...\n', 'info');
      
      await testStocks();
      await testFinanceOrders();
      await testFinanceExpenses();
      
      log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
      log('‚úì –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã', 'success');
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', 'info');
    }

    function showStats(stats) {
      const section = document.getElementById('stats-section');
      const container = document.getElementById('stats');
      
      section.style.display = 'block';
      container.innerHTML = '';
      
      Object.entries(stats).forEach(([label, value]) => {
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.innerHTML = `
          <div class="stat-label">${label}</div>
          <div class="stat-value">${value}</div>
        `;
        container.appendChild(card);
      });
    }
  </script>
</body>
</html>
